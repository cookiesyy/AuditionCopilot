name: Build AuditionCopilot

# 触发条件：推送到main分支或创建tag时自动编译
on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: windows-latest  # 使用Windows环境编译

    steps:
    # 1. 检出代码
    - name: 检出代码
      uses: actions/checkout@v3

    # 2. 设置MSBuild环境
    - name: 设置MSBuild
      uses: microsoft/setup-msbuild@v1.1

    # 3. 设置NuGet
    - name: 设置NuGet
      uses: NuGet/setup-nuget@v1

    # 4. 还原NuGet包
    - name: 还原NuGet包
      run: nuget restore AuditionCopilot.sln

    # 5. 编译项目（Debug版本）
    - name: 编译Debug版本
      run: msbuild AuditionCopilot.sln /p:Configuration=Debug /p:Platform=x86

    # 6. 编译项目（Release版本）
    - name: 编译Release版本
      run: msbuild AuditionCopilot.sln /p:Configuration=Release /p:Platform=x86

    # 7. 收集编译产物
    - name: 收集编译文件
      run: |
        mkdir -p release-package
        Copy-Item -Path "AuditionCopilot/bin/Release/*" -Destination "release-package/" -Recurse
        Copy-Item -Path "编译说明.md" -Destination "release-package/" -ErrorAction SilentlyContinue
        Copy-Item -Path "README.md" -Destination "release-package/" -ErrorAction SilentlyContinue
      shell: pwsh

    # 8. 上传编译产物
    - name: 上传Release版本
      uses: actions/upload-artifact@v3
      with:
        name: AuditionCopilot-Release
        path: release-package/

    - name: 上传Debug版本
      uses: actions/upload-artifact@v3
      with:
        name: AuditionCopilot-Debug
        path: AuditionCopilot/bin/Debug/

    # 9. 如果是tag推送，创建GitHub Release
    - name: 创建Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-package/AuditionCopilot.exe
          release-package/*.dll
        body: |
          ## AuditionCopilot 自动编译版本

          ### 修改内容
          - 游戏窗口名称已修改为：**劲舞团 华东一区**

          ### 使用说明
          1. 下载所有文件到同一目录
          2. 确保安装了 .NET Framework 4.8
          3. 下载并加载DD驱动
          4. 运行 AuditionCopilot.exe

          ### 系统要求
          - Windows 10/11
          - .NET Framework 4.8
          - 屏幕分辨率：1920×1080

          详细说明请查看 [编译说明.md](https://github.com/${{ github.repository }}/blob/main/编译说明.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
